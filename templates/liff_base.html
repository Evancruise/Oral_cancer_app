<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title> é†«å¿«æ‹ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <!-- å´é‚Šé¸å–® -->
    <div class="sidebar">
        <div class="user-info">
            <p>è‡ºå¤§é†«é™¢å½±åƒé†«å­¸éƒ¨</p>
            <img src="https://cdn-icons-png.flaticon.com/512/850/850960.png" alt="icon" class="user-icon">
        </div>
        <ul class="menu">
            <li><i class="fas fa-home"></i> <a class="nav-link {{ 'active' if request.path == '/login' else '' }}" href="/login"> é¦–é </a></li>
            <li><i class="fas fa-history"></i> <a class="nav-link {{ 'active' if request.path == '/history' else '' }}" href="/history"> ç—…æ­·ç´€éŒ„</a></li>
            <li><i class="fas fa-trash"></i> <a class="nav-link {{ 'active' if request.path == '/discard_history' else '' }}" href="/discard_history"> åƒåœ¾æ¡¶</a></li>
            <li><i class="fas fa-key"></i> å¿«é€Ÿå¯†ç¢¼è®Šæ›´</li>
            <li><i class="fas fa-link"></i> é‡æ–°ç¶å®š</li>
            <li><i class="fas fa-sign-out-alt"></i> <a class="nav-link" href="/logout">ç™»å‡º</a></li>
        </ul>
        <div class="version">ver 1.0</div>
    </div>

    <!-- ä¸»å…§å®¹å€ -->
    <main>
        {% block content %}
        {% endblock %}
    </main>

    <div id="modal-container"></div>
    <div id="modal-container-loading"></div>

    <!-- Bootstrap script -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { logUploadedFiles, bindImageUploadPreview, bindImageResultPreview, showLoadingModal, loadModal, loadingModal, showModal, hideLoadingModal } from "{{ url_for('static', filename='js/modal.js') }}";
        loadModal("modal-container");
        loadModal("modal-container-loading");

        document.addEventListener("DOMContentLoaded", function () {
            const parts = [
                ["1", "ä¸Šç‰™é½¦"],
                ["2", "ä¸Šé¡"],
                ["3", "å³é °"],
                ["4", "èˆŒå³"],
                ["5", "èˆŒå·¦"],
                ["6", "å·¦é °"],
                ["7", "èˆŒä¸‹"],
                ["8", "ä¸‹ç‰™é½¦"]
            ];
            const icons = document.querySelectorAll(".rotate-icon");
            const add_form = document.getElementById("add_form");
            const edit_form = document.getElementById("edit_form");
            const result_form = document.getElementById("result_form");
            const delete_form = document.getElementById("delete_form");
            const add_modal = document.getElementById("newRecordModal");
            const edit_modal = document.getElementById("editRecordModal");
            const result_modal = document.getElementById("resultRecordModal");
            const delete_modal = document.getElementById("viewRecordModal");
            const record_link = document.querySelectorAll(".record-link");
            const record_discard_link = document.querySelectorAll(".record-link-discard");
            let current_patient_id = "";
            let clickedButton = null;
            const patient_ids = {{ all_patient_ids | default([]) | tojson }};
            const patientStatusMap = {};

            if (edit_form) {
                bindImageUploadPreview(parts, edit_form);
                logUploadedFiles(edit_form);
            }

            if (add_form) {
                bindImageUploadPreview(parts, add_form);
                logUploadedFiles(add_form);
            }

            if (result_form) {
                bindImageResultPreview(parts, result_form);
                logUploadedFiles(result_form);
            }

            if (delete_form) {
                bindImageResultPreview(parts, delete_form);
                logUploadedFiles(delete_form);
            }

            if (add_modal) {
                add_modal.addEventListener("hidden.bs.modal", () => {
                    console.log("âœŒï¸ Edit Modal å·²é—œé–‰");

                    // ğŸ‘‰ è‡ªè¨‚è¡Œç‚ºï¼Œä¾‹å¦‚æ¸…ç©ºæ¬„ä½ã€é‡è¨­ collapse ç‹€æ…‹ã€åœ–ç‰‡ preview ç­‰
                    if (add_modal) {
                        const modal = bootstrap.Modal.getInstance(add_modal); // å–å¾—å·²å­˜åœ¨çš„ modal å¯¦ä¾‹
                        if (modal) {
                            modal.hide(); // éš±è—
                        }
                    }
                });
            }

            if (edit_modal) {
                edit_modal.addEventListener("hidden.bs.modal", () => {
                    console.log("âœŒï¸ Edit Modal å·²é—œé–‰");

                    // ğŸ‘‰ è‡ªè¨‚è¡Œç‚ºï¼Œä¾‹å¦‚æ¸…ç©ºæ¬„ä½ã€é‡è¨­ collapse ç‹€æ…‹ã€åœ–ç‰‡ preview ç­‰
                    if (edit_modal) {
                        const modal = bootstrap.Modal.getInstance(edit_modal); // å–å¾—å·²å­˜åœ¨çš„ modal å¯¦ä¾‹
                        if (modal) {
                            modal.hide(); // éš±è—
                        }
                    }
                });
            }

            if (result_modal) {
                result_modal.addEventListener("hidden.bs.modal", () => {
                    console.log("âœŒï¸ Edit Modal å·²é—œé–‰");

                    // ğŸ‘‰ è‡ªè¨‚è¡Œç‚ºï¼Œä¾‹å¦‚æ¸…ç©ºæ¬„ä½ã€é‡è¨­ collapse ç‹€æ…‹ã€åœ–ç‰‡ preview ç­‰
                    if (result_modal) {
                        const modal = bootstrap.Modal.getInstance(result_modal); // å–å¾—å·²å­˜åœ¨çš„ modal å¯¦ä¾‹
                        if (modal) {
                            modal.hide(); // éš±è—
                        }
                    }
                });
            }

            if (delete_modal) {
                delete_modal.addEventListener("hidden.bs.modal", () => {
                    console.log("âœŒï¸ Edit Modal å·²é—œé–‰");

                    // ğŸ‘‰ è‡ªè¨‚è¡Œç‚ºï¼Œä¾‹å¦‚æ¸…ç©ºæ¬„ä½ã€é‡è¨­ collapse ç‹€æ…‹ã€åœ–ç‰‡ preview ç­‰
                    if (delete_modal) {
                        const modal = bootstrap.Modal.getInstance(delete_modal); // å–å¾—å·²å­˜åœ¨çš„ modal å¯¦ä¾‹
                        if (modal) {
                            modal.hide(); // éš±è—
                        }
                    }
                });
            }

            function updateIconForPatient(pid, status) {
                const iconContainer = document.getElementById(`icon-${pid}`);
                if (!iconContainer) return;

                let iconHtml = '';
                switch (status) {
                    case 'in_progress':
                        iconHtml = '<i class="fas fa-spinner fa-spin text-warning"></i>';
                        break;
                    case 'done':
                        iconHtml = '<i class="fas fa-check-circle text-success"></i>';
                        break;
                    case "failed":
                        iconHtml = '<i class="fas fa-clock text-secondary"></i>';
                        break;
                    default:
                        iconHtml = '<i class="fas fa-camera"></i>';
                        break;
                }
                iconContainer.innerHTML = iconHtml;
            }

            async function checkInferenceForPatients(patient_ids) {
                for (const pid of patient_ids) {

                    if (patientStatusMap[pid] === 'done' || patientStatusMap[pid] === 'failed') {
                        continue;
                    }

                    try {
                        const res1 = await fetch(`/record/check_inference/${pid}`);
                        const data1 = await res1.json();
                        console.log(`${pid} â†’`, data1.status);

                        patientStatusMap[pid] = data1.status;

                        updateIconForPatient(pid, data1.status);
                    } catch (err) {
                        console.error(`Error cehcking inference for ${pid}:`, err);
                    }
                }
            }

            document.querySelectorAll('.section-toggle').forEach(toggle => {
                toggle.addEventListener('click', function () {
                    const icon = this.querySelector('.rotate-icon');
                    const isExpanded = this.getAttribute('aria-expanded') === 'true';
                    icon.style.transform = isExpanded ? 'rotate(0deg)' : 'rotate(180deg)';
                });
            });

            document.querySelectorAll("#add_form button[type=submit]").forEach(btn => {
                btn.addEventListener("click", () => {
                    clickedButton = btn;
                });
            });

            document.querySelectorAll("#edit_form button[type=submit]").forEach(btn => {
                btn.addEventListener("click", () => {
                    clickedButton = btn;
                });
            });

            document.querySelectorAll("#result_form button[type=submit]").forEach(btn => {
                btn.addEventListener("click", () => {
                    console.log("result_form tag triggered!");
                    clickedButton = btn;
                });
            });

            document.querySelectorAll("#delete_form button[type=submit]").forEach(btn => {
                btn.addEventListener("click", () => {
                    console.log("delete_form tag triggered!");
                    clickedButton = btn;
                });
            });

            if (record_link) {
                record_link.forEach(link => {
                    link.addEventListener("click", function () {
                        const modal = document.getElementById("editRecordModal");
                        console.log("this.dataset:", this.dataset);
                        modal.querySelector("input[name='name']").value = this.dataset.name;
                        modal.querySelector("select[name='gender']").value = this.dataset.gender;
                        modal.querySelector("input[name='age']").value = this.dataset.age;
                        modal.querySelector("input[name='patient_id']").value = this.dataset.patient_id;
                        /*
                        modal.querySelector("input[name='pic1']").value = this.dataset.pic1;
                        modal.querySelector("input[name='pic2']").value = this.dataset.pic2;
                        modal.querySelector("input[name='pic3']").value = this.dataset.pic3;
                        modal.querySelector("input[name='pic4']").value = this.dataset.pic4;
                        modal.querySelector("input[name='pic5']").value = this.dataset.pic5;
                        modal.querySelector("input[name='pic6']").value = this.dataset.pic6;
                        modal.querySelector("input[name='pic7']").value = this.dataset.pic7;
                        modal.querySelector("input[name='pic8']").value = this.dataset.pic8;
                        */
                        modal.querySelector("textarea[name='notes']").value = this.dataset.notes;

                        modal.querySelector(`#preview_1`).src = this.dataset.pic1;
                        modal.querySelector(`#preview_2`).src = this.dataset.pic2;
                        modal.querySelector(`#preview_3`).src = this.dataset.pic3;
                        modal.querySelector(`#preview_4`).src = this.dataset.pic4;
                        modal.querySelector(`#preview_5`).src = this.dataset.pic5;
                        modal.querySelector(`#preview_6`).src = this.dataset.pic6;
                        modal.querySelector(`#preview_7`).src = this.dataset.pic7;
                        modal.querySelector(`#preview_8`).src = this.dataset.pic8;

                        // åŠ å…¥ record_id hidden æ¬„ä½ï¼ˆæˆ–ä½¿ç”¨ query åƒæ•¸ï¼‰
                        const hiddenInput = document.createElement("input");
                        hiddenInput.type = "hidden";
                        hiddenInput.name = "record_id";
                        hiddenInput.value = this.dataset.record_id;
                        modal.querySelector("form").appendChild(hiddenInput);
                    });
                });
            }

            if (record_discard_link) {
                record_discard_link.forEach(link => {
                    link.addEventListener("click", function () {
                        const modal = document.getElementById("viewRecordModal");
                        console.log("this.dataset:", this.dataset);
                        modal.querySelector("input[name='name']").value = this.dataset.name;
                        modal.querySelector("select[name='gender']").value = this.dataset.gender;
                        modal.querySelector("input[name='age']").value = this.dataset.age;
                        modal.querySelector("input[name='patient_id']").value = this.dataset.patient_id;
                        /*
                        modal.querySelector("input[name='pic1']").value = this.dataset.pic1;
                        modal.querySelector("input[name='pic2']").value = this.dataset.pic2;
                        modal.querySelector("input[name='pic3']").value = this.dataset.pic3;
                        modal.querySelector("input[name='pic4']").value = this.dataset.pic4;
                        modal.querySelector("input[name='pic5']").value = this.dataset.pic5;
                        modal.querySelector("input[name='pic6']").value = this.dataset.pic6;
                        modal.querySelector("input[name='pic7']").value = this.dataset.pic7;
                        modal.querySelector("input[name='pic8']").value = this.dataset.pic8;
                        */
                        modal.querySelector("textarea[name='notes']").value = this.dataset.notes;

                        modal.querySelector(`#preview_1`).src = this.dataset.pic1;
                        modal.querySelector(`#preview_2`).src = this.dataset.pic2;
                        modal.querySelector(`#preview_3`).src = this.dataset.pic3;
                        modal.querySelector(`#preview_4`).src = this.dataset.pic4;
                        modal.querySelector(`#preview_5`).src = this.dataset.pic5;
                        modal.querySelector(`#preview_6`).src = this.dataset.pic6;
                        modal.querySelector(`#preview_7`).src = this.dataset.pic7;
                        modal.querySelector(`#preview_8`).src = this.dataset.pic8;

                        // åŠ å…¥ record_id hidden æ¬„ä½ï¼ˆæˆ–ä½¿ç”¨ query åƒæ•¸ï¼‰
                        const hiddenInput = document.createElement("input");
                        hiddenInput.type = "hidden";
                        hiddenInput.name = "record_id";
                        hiddenInput.value = this.dataset.record_id;
                        modal.querySelector("form").appendChild(hiddenInput);
                    });
                });
            }

            icons.forEach(icon => {
                const targetId = icon.dataset.target;
                const target = document.querySelector(targetId);

                // åˆå§‹åŒ–ç‹€æ…‹
                if (target && !target.classList.contains("show")) {
                    icon.classList.remove("rotate");
                } else {
                    icon.classList.add("rotate");
                }

                // ç¶å®š collapse å‹•ç•«äº‹ä»¶
                const collapseElement = new bootstrap.Collapse(target, { toggle: false });

                target.addEventListener("show.bs.collapse", function () {
                    icon.classList.add("rotate");
                });
                target.addEventListener("hide.bs.collapse", function () {
                    icon.classList.remove("rotate");
                });
            });

            if (edit_form) {

                edit_form.addEventListener("submit", async function(e) {
                    e.preventDefault();

                    if (clickedButton && clickedButton.value === "save") {
                        console.log("ä½¿ç”¨è€…é»äº†é–‹å§‹ç·¨è¼¯ç—…æ­·");

                        const formData = new FormData(edit_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        try {

                            if (!current_patient_id) {
                                showModal("æ‰¾ä¸åˆ°ç—…æ­· IDï¼Œç„¡æ³•å•Ÿå‹•æ¨è«–", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                return;
                            }

                            const res_edit = await fetch(`/record/edit/{{ user_id }}`, {
                                method: "POST",
                                body: formData
                            });

                            const data_edit = await res_edit.json();
                            console.log("data:", data_edit);

                            if (!data_edit || !data_edit.status) {
                                throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤");
                                return;
                            }

                            if (data_edit.status === "ok") {

                                const modalElement = document.getElementById('newRecordModal');
                                if (modalElement) {
                                    const modal = bootstrap.Modal.getInstance(modalElement); // å–å¾—å·²å­˜åœ¨çš„ modal å¯¦ä¾‹
                                    if (modal) {
                                        modal.hide(); // éš±è—
                                    }
                                }

                                showModal("ç·¨è¼¯ç—…æ­·æˆåŠŸ", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    window.location.href = data_edit.redirect;
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            } else {

                                if (data.message === "request token changed") {
                                    showModal("ä½¿ç”¨è€…è«‹æ±‚é­æ‹’ï¼Œè«‹å†è©¦ä¸€æ¬¡", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                }
                            }
                        } catch (err) {
                            console.log("ç™¼ç”ŸéŒ¯èª¤");
                        }
                    } else if (clickedButton && clickedButton.value === "delete") {
                        console.log("ä½¿ç”¨è€…é»äº†åˆªé™¤ç—…æ­·");

                        const formData = new FormData(edit_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        try {

                            if (!current_patient_id) {
                                showModal("æ‰¾ä¸åˆ°ç—…æ­· IDï¼Œç„¡æ³•å•Ÿå‹•æ¨è«–", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                return;
                            }

                            const res_edit1 = await fetch(`/record/delete/{{ user_id }}/${current_patient_id}`, {
                                method: "POST",
                                body: formData
                            });

                            const data_edit1 = await res_edit1.json();
                            console.log("data:", data_edit1);

                            if (!data_edit1 || !data_edit1.status) {
                                throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤");
                                return;
                            }

                            if (data_edit1.status === "ok") {

                                showModal("åˆªé™¤ç—…æ­·æˆåŠŸ", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    window.location.href = data_edit1.redirect;
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            } else {

                                if (data.message === "request token changed") {
                                    showModal("ä½¿ç”¨è€…è«‹æ±‚é­æ‹’ï¼Œè«‹å†è©¦ä¸€æ¬¡", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                } else {
                                    showModal("åˆªé™¤ç—…ä¾‹å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                }
                            }
                        } catch (err) {
                            console.log("ç™¼ç”ŸéŒ¯èª¤");
                        }
                    } else if (clickedButton && clickedButton.value === "infer") {
                        // let missing = [];
                        let uploadedFilenames = [];

                        const formData = new FormData(edit_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        /*
                        parts.forEach(([code, label]) => {
                            
                            const input = edit_form.querySelector(`#upload_${code}`);

                            console.log(`input #upload_${code}:`, input);

                            if (!input.files || input.files.length === 0) {
                                missing.push(code);
                            } else {
                                uploadedFilenames.push(input.files[0].name);
                            }
                        });

                        if (missing.length > 0) {
                            showModal("è«‹ä¸Šå‚³æ‰€æœ‰éƒ¨ä½å½±åƒ", () => {
                                // OK æ™‚åŸ·è¡Œ
                                console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                            }, () => {
                                // Cancel æ™‚åŸ·è¡Œ
                                console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                            });
                            return;
                        }
                        */

                        try {
                            if (!current_patient_id) {
                                showModal("æ‰¾ä¸åˆ°ç—…æ­· IDï¼Œç„¡æ³•å•Ÿå‹•æ¨è«–");
                                return;
                            }

                            const res_edit2 = await fetch(`/record/edit/{{ user_id }}`, {
                                method: "POST",
                                body: formData
                            });

                            const data_edit2 = await res_edit2.json();
                            console.log("data:", data_edit2);

                            if (!data_edit2 || !data_edit2.status) {
                                throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤");
                                return;
                            }

                            if (data_edit2.status === "ok" && data_edit2.redirect) {

                                fetch(`/record/trigger_infer_process/${current_patient_id}`)
                                .then(response => {
                                    if (response.status === 202) {
                                        console.log("Inference started in background.");

                                        const modalElement = document.getElementById('editRecordModal');
                                        if (modalElement) {
                                            const modal = bootstrap.Modal.getInstance(modalElement);
                                            if (modal) {
                                                modal.hide();
                                            }
                                        }

                                        loadingModal("æ¨¡å‹æ¨è«–ä¸­ï¼Œè«‹ç¨å¾Œ...",
                                            () => {
                                                const editModalEl = edit_modal;
                                                const editModal = new bootstrap.Modal(editModalEl);
                                                editModal.show();
                                            },
                                            () => {
                                                const editModalEl = edit_modal;
                                                const editModal = new bootstrap.Modal(editModalEl);
                                                editModal.show();
                                                console.log("æŒ‰ä¸‹ Cancel, ä¸¦å·²ç™¼é€ /cancel_training");
                                            }, current_patient_id
                                            , true
                                        );
                                    } else {
                                        console.error("Unexpected response:", response.status);
                                        return;
                                    }
                                });

                                const res_edit3 = await fetch(`/record/start_inference/${current_patient_id}`, {
                                    method: "POST",
                                    body: formData
                                });

                                const data_edit3 = await res_edit3.json()

                                if (!data_edit3 || !data_edit3.status) {
                                    throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤");
                                    return;
                                }

                                if (data_edit3.status === "done") {
                                    const pollingInterval = 3000;
                                    const maxRetries = 60;
                                    let attempts = 0;

                                    const intervalId = setInterval(async () => {
                                        try {
                                            const res_edit4 = await fetch(`/record/check_inference/${current_patient_id}`, {
                                                method: "GET"
                                            });

                                            const data_edit4 = await res_edit4.json();
                                            const message = data_edit4.message;
                                            const status = data_edit4.status;
                                            const percent = Math.min(data_edit4.progress, 100);

                                            console.log(`ç¬¬ ${attempts + 1} æ¬¡æŸ¥è©¢ï¼Œç‹€æ…‹: ${status}, è¨Šæ¯: ${message}`);

                                            if (percent > 0) {
                                                
                                                const modal = document.getElementById("modal-container-loading");
                                                if (modal) {
                                                    const progressBar = modal.querySelector("#progressBar");
                                                    if (progressBar) {
                                                        progressBar.style.width = `${percent}%`;
                                                        progressBar.innerText = `${percent}%`;
                                                    }
                                                }
                                            }

                                            // è¾¨è­˜å®Œæˆå°±åœæ­¢è¼ªè©¢
                                            if (status === "done") {

                                                hideLoadingModal();

                                                clearInterval(intervalId);
                                                showModal("è¾¨è­˜å®Œæˆï¼š" + message, () => {
                                                    window.location.href = data_edit2.redirect;
                                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                                }, () => {
                                                    window.location.href = data_edit2.redirect;
                                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                                });
                                                // ä½ å¯ä»¥åœ¨é€™è£¡åŠ å…¥å¾ŒçºŒè™•ç†é‚è¼¯ï¼ˆä¾‹å¦‚é¡¯ç¤ºçµæœï¼‰
                                                return;

                                            } else if (status === "error") {

                                                hideLoadingModal();

                                                showModal("è¾¨è­˜å¤±æ•—ï¼š" + message, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                                }, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                                });
                                                return;
                                            }

                                            // å¦‚æœè¶…éæœ€å¤§æ¬¡æ•¸é‚„æ²’å®Œæˆï¼Œå°±åœæ­¢
                                            if (++attempts >= maxRetries) {
                                                clearInterval(intervalId);
                                                showModal("è¾¨è­˜é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦", () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                                }, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                                });
                                            }
                                        } catch (pollErr) {
                                            clearInterval(intervalId);
                                            showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                            }, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                            });
                                        }
                                    }, pollingInterval);
                                } else {
                                    if (data_edit3.message === "FileFoundEmpty") {
                                        showModal("è«‹ä¸Šå‚³æ‰€æœ‰éƒ¨ä½å½±åƒ", () => {
                                            // OK æ™‚åŸ·è¡Œ
                                            console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                                        }, () => {
                                            // Cancel æ™‚åŸ·è¡Œ
                                            console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                                        });
                                        return;
                                    }
                                }
                            } else {
                                showModal("è«‹ç¢ºèª ä¸Šå‚³æ‰€æœ‰å½±åƒ / æ²’æœ‰é‡è¤‡å½±åƒ å¾Œå†é€²è¡Œæ¨è«–", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            }
                        } catch (err) {
                            showModal("æ¨è«–å•Ÿå‹•å¤±æ•—ï¼š" + err.message, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        }
                    } else if (clickedButton && clickedButton.value === "check_result") {

                        const formData = new FormData(edit_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        openResultModal(edit_modal, formData, true);

                        const pollingInterval = 3000; // æ¯ 3 ç§’æŸ¥ä¸€æ¬¡
                        const maxRetries = 60; // æœ€å¤šè¼ªè©¢ 60 æ¬¡ (3 åˆ†é˜)
                        let attempts = 0;

                        const intervalId = setInterval(async () => {
                            try {
                                const res_edit5 = await fetch(`/record/retrieve_results/${current_patient_id}`, {
                                    method: "GET"
                                });

                                const data_edit5 = await res_edit5.json();

                                if (data_edit5.message === "not found") {
                                    showModal(`æ²’æœ‰æ­¤ç—…æ‚£çš„è¾¨è­˜çµæœè³‡æ–™ (id=${current_patient_id})`, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                } else {
                                    const record_dict = data_edit5.record_dict;

                                    const fields = [1, 2, 3, 4, 5, 6, 7, 8];
                                    fields.forEach((i) => {
                                        if (result_modal && record_dict[`img${i}`]) {
                                            result_modal.querySelector(`#upload_${i}`).src = record_dict[`img${i}`];
                                        }
                                    });

                                    clearInterval(intervalId);
                                }

                                // å¦‚æœè¶…éæœ€å¤§æ¬¡æ•¸é‚„æ²’å®Œæˆï¼Œå°±åœæ­¢
                                if (++attempts >= maxRetries) {
                                    clearInterval(intervalId);
                                    showModal("è¾¨è­˜é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                }
                            } catch(pollErr) {
                                clearInterval(intervalId);
                                showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            }
                        }, pollingInterval);

                        return;
                    }

                    clickedButton = null; // reset
                });

                bindImageUploadPreview(parts, edit_form);
            }

            if (add_form) {
                add_form.addEventListener("submit", async function(e) {
                    e.preventDefault();

                    if (clickedButton && clickedButton.value === "create") {
                        console.log("ä½¿ç”¨è€…é»äº†é–‹å§‹å»ºç«‹ç—…æ­·");

                        const formData = new FormData(add_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        try {
                            const res_add = await fetch(`/record/new/{{ user_id }}`, {
                                method: "POST",
                                body: formData
                            });

                            const data_add = await res_add.json();
                            console.log("data:", data_add);

                            if (!data_add || !data_add.status) {
                                throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤");
                                return;
                            }

                            if (data_add.status === "ok") {

                                const modalElement = document.getElementById('newRecordModal');
                                if (modalElement) {
                                    const modal = bootstrap.Modal.getInstance(modalElement); // å–å¾—å·²å­˜åœ¨çš„ modal å¯¦ä¾‹
                                    if (modal) {
                                        modal.hide(); // éš±è—
                                    }
                                }

                                showModal("å»ºç«‹ç—…æ­·æˆåŠŸ", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    window.location.href = data_add.redirect;
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            } else {

                                if (data_add.message === "patient id existed") {
                                    showModal("å»ºç«‹ç—…æ­·å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ (ä½¿ç”¨è€…patient idé‡è¤‡)", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                } else if (data_add.message === "request token changed") {
                                    showModal("ä½¿ç”¨è€…è«‹æ±‚é­æ‹’ï¼Œè«‹å†è©¦ä¸€æ¬¡", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                }
                            }
                        } catch (err) {
                            console.log("ç™¼ç”ŸéŒ¯èª¤");
                        }
                    } else if (clickedButton && clickedButton.value === "infer") {
                        //let missing = [];
                        let uploadedFilenames = [];

                        const formData = new FormData(add_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        /*
                        parts.forEach(([code, label]) => {
                            
                            const input = add_form.querySelector(`#upload_${code}`);

                            console.log(`input #upload_${code}:`, input);

                            if (!input.files || input.files.length === 0) {
                                missing.push(code);
                            } else {
                                uploadedFilenames.push(input.value);
                            }
                        });

                        if (missing.length > 0) {
                            showModal("è«‹ä¸Šå‚³æ‰€æœ‰éƒ¨ä½å½±åƒ", () => {
                                // OK æ™‚åŸ·è¡Œ
                                console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                            }, () => {
                                // Cancel æ™‚åŸ·è¡Œ
                                console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                            });
                            return;
                        }
                        */

                        try {
                            // 1. é€å‡º POST è«‹æ±‚é–‹å§‹æ¨è«–

                            if (!current_patient_id) {
                                showModal("æ‰¾ä¸åˆ°ç—…æ­· IDï¼Œç„¡æ³•å•Ÿå‹•æ¨è«–");
                                return;
                            }

                            const res_add1 = await fetch(`/record/new/{{ user_id }}`, {
                                method: "POST",
                                body: formData
                            });

                            const data_add1 = await res_add1.json();
                            console.log("data:", data_add1);

                            if (!data_add1 || !data_add1.status) {
                                throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤");
                                return;
                            }

                            if (data_add1.status === "ok" && data_add1.redirect) {

                                fetch(`/record/trigger_infer_process/${current_patient_id}`)
                                .then(response => {
                                    if (response.status === 202) {
                                        console.log("Inference started in background.");

                                        const modalElement = document.getElementById('newRecordModal');
                                        if (modalElement) {
                                            const modal = bootstrap.Modal.getInstance(modalElement);
                                            if (modal) {
                                                modal.hide();
                                            }
                                        }

                                        loadingModal("æ¨¡å‹æ¨è«–ä¸­ï¼Œè«‹ç¨å¾Œ...",
                                            () => {
                                                const addModalEl = add_modal;
                                                const addModal = new bootstrap.Modal(addModalEl);
                                                addModal.show();
                                            },
                                            () => {
                                                const addModalEl = add_modal;
                                                const addModal = new bootstrap.Modal(addModalEl);
                                                addModal.show();
                                                console.log("æŒ‰ä¸‹ Cancel, ä¸¦å·²ç™¼é€ /cancel_training");
                                            }, current_patient_id
                                            , true
                                        );
                                    } else {
                                        console.error("Unexpected response:", response.status);
                                        return;
                                    }
                                });

                                const res_add2 = await fetch(`/record/start_inference/${current_patient_id}`, {
                                    method: "POST",
                                    body: formData
                                });

                                const data_add2 = await res_add2.json();
                                console.log("data:", data_add2);

                                if (!data_add2 || !data_add2.status) {
                                    throw new Error("å›å‚³æ ¼å¼éŒ¯èª¤");
                                    return;
                                }

                                if (data_add2.status === "done") {
                                    const pollingInterval = 3000; // æ¯ 3 ç§’æŸ¥ä¸€æ¬¡
                                    const maxRetries = 60; // æœ€å¤šè¼ªè©¢ 60 æ¬¡ (3 åˆ†é˜)
                                    let attempts = 0;

                                    const intervalId = setInterval(async () => {
                                        try {
                                            const res_add3 = await fetch(`/record/check_inference/${current_patient_id}`, {
                                                method: "GET"
                                            });

                                            const data_add3 = await res_add3.json();
                                            const message = data_add3.message;
                                            const status = data_add3.status;
                                            const percent = data_add3.progress;

                                            if (percent > 0) {
                                                const modal = document.getElementById("loadingModal");
                                                if (modal) {
                                                    const progressBar = modal.querySelector("#progressBar");
                                                    if (progressBar) {
                                                        progressBar.style.width = `${percent}%`;
                                                        progressBar.innerText = `${percent}%`;
                                                    }
                                                }
                                            }

                                            console.log(`ç¬¬ ${attempts + 1} æ¬¡æŸ¥è©¢ï¼Œç‹€æ…‹: ${status}, è¨Šæ¯: ${message}`);

                                            // è¾¨è­˜å®Œæˆå°±åœæ­¢è¼ªè©¢
                                            if (status === "done") {

                                                hideLoadingModal();

                                                clearInterval(intervalId);
                                                showModal("è¾¨è­˜å®Œæˆï¼š" + message, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                                    window.location.href = data_add1.redirect;
                                                }, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                                    window.location.href = data_add1.redirect;
                                                });
                                                // ä½ å¯ä»¥åœ¨é€™è£¡åŠ å…¥å¾ŒçºŒè™•ç†é‚è¼¯ï¼ˆä¾‹å¦‚é¡¯ç¤ºçµæœï¼‰
                                                return;

                                            } else if (status === "error") {
                                                clearInterval(intervalId);

                                                hideLoadingModal();

                                                showModal("è¾¨è­˜å¤±æ•—ï¼š" + message, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                                }, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                                });
                                                return;
                                            }

                                            // å¦‚æœè¶…éæœ€å¤§æ¬¡æ•¸é‚„æ²’å®Œæˆï¼Œå°±åœæ­¢
                                            if (++attempts >= maxRetries) {
                                                clearInterval(intervalId);
                                                showModal("è¾¨è­˜é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦", () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                                }, () => {
                                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                                });
                                            }
                                        } catch (pollErr) {
                                            clearInterval(intervalId);
                                            showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                            }, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                            });
                                        }
                                    }, pollingInterval);
                                } else {
                                    if (data_add2.message === "FileFoundEmpty") {
                                        showModal("è«‹ä¸Šå‚³æ‰€æœ‰éƒ¨ä½å½±åƒ", () => {
                                            // OK æ™‚åŸ·è¡Œ
                                            console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                                        }, () => {
                                            // Cancel æ™‚åŸ·è¡Œ
                                            console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                                        });
                                        return;
                                    }
                                }
                            } else {
                                showModal("è«‹ç¢ºèª ä¸Šå‚³æ‰€æœ‰å½±åƒ / æ²’æœ‰é‡è¤‡å½±åƒ å¾Œå†é€²è¡Œæ¨è«–", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            }
                        } catch (err) {
                            showModal("æ¨è«–å•Ÿå‹•å¤±æ•—ï¼š" + err.message, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        }
                    } else if (clickedButton && clickedButton.value === "check_result") {

                        const formData = new FormData(add_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        openResultModal(add_modal, formData, true);

                        const pollingInterval = 3000; // æ¯ 3 ç§’æŸ¥ä¸€æ¬¡
                        const maxRetries = 60; // æœ€å¤šè¼ªè©¢ 60 æ¬¡ (3 åˆ†é˜)
                        let attempts = 0;

                        const intervalId = setInterval(async () => {
                            try {
                                const res_add4 = await fetch(`/record/retrieve_results/${current_patient_id}`, {
                                    method: "GET"
                                });

                                const data_add4 = await res_add4.json();

                                if (data_add4.message === "not found") {
                                    clearInterval(intervalId);
                                    showModal(`æ²’æœ‰æ­¤ç—…æ‚£çš„è¾¨è­˜çµæœè³‡æ–™ (id=${current_patient_id})`, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                } else {
                                    const record_dict = data_add4.record_dict;

                                    const fields = [1, 2, 3, 4, 5, 6, 7, 8];
                                    fields.forEach((i) => {
                                        if (result_modal && record_dict[`img${i}`]) {
                                            result_modal.querySelector(`#upload_${i}`).src = record_dict[`img${i}`];
                                        }
                                    });
                                    clearInterval(intervalId);
                                }

                                // å¦‚æœè¶…éæœ€å¤§æ¬¡æ•¸é‚„æ²’å®Œæˆï¼Œå°±åœæ­¢
                                if (++attempts >= maxRetries) {
                                    clearInterval(intervalId);
                                    showModal("è¾¨è­˜é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                }
                            } catch(pollErr) {
                                clearInterval(intervalId);
                                showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            }
                        }, pollingInterval);

                        return;
                    }

                    clickedButton = null; // reset
                });

                bindImageUploadPreview(parts, add_form);
            }

            if (result_form) {
                result_form.addEventListener("submit", async function(e) {
                    e.preventDefault();

                    if (clickedButton && clickedButton.value === "upload") {

                        const formData = new FormData(result_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        openResultModal(result_modal, formData, false);

                        const pollingInterval = 3000; // æ¯ 3 ç§’æŸ¥ä¸€æ¬¡
                        const maxRetries = 60; // æœ€å¤šè¼ªè©¢ 60 æ¬¡ (3 åˆ†é˜)
                        let attempts = 0;
                        
                        try {
                            const res_result = await fetch("/record/result/{{ user_id }}", {
                                method: "POST",
                                body: formData
                            });
                            const data_result = await res_result.json();
                            
                            if (!data_result && !data_result.status) {
                                throw new Error("ä¸Šå‚³å½±åƒç™¼ç”ŸéŒ¯èª¤");
                                return;
                            }

                            if (data_result.status === "ok") {

                                const resultModal = new bootstrap.Modal(result_modal);
                                if (resultModal) {
                                    resultModal.hide();
                                }

                                loadingModal("ä¸Šå‚³å½±åƒä¸­ï¼Œè«‹ç¨å¾Œ...", 
                                () => {
                                    resultModal.show();
                                },
                                () => {
                                    resultModal.show();
                                    console.log("æŒ‰ä¸‹ Cancel, ä¸¦å·²ç™¼é€ /cancel_training");
                                }, null
                                , false);

                                const intervalId = setInterval(async () => {
                                    try {
                                        const res_result1 = await fetch(`/record/upload_result/${current_patient_id}`, {
                                            method: "GET"
                                        });

                                        const data_result1 = await res_result1.json();

                                        if (data_result1.status === "done") {
                                            clearInterval(intervalId);

                                            hideLoadingModal();

                                            showModal(`ä¸Šå‚³å½±åƒå®Œæˆ (patient id: ${current_patient_id})`, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                                // window.location.href = data_result1.redirect;
                                            }, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                            });
                                            
                                        } else if (data_result1.status === "failed") {
                                            clearInterval(intervalId);

                                            hideLoadingModal();

                                            showModal(`ä¸Šå‚³å½±åƒå¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯: ${data_result1.message}`, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                            }, () => {
                                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                            });
                                            return;
                                        }
                                    } catch (pollErr) {
                                        clearInterval(intervalId);

                                        hideLoadingModal();

                                        showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                                            console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                        }, () => {
                                            console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                        });
                                    }
                                }, pollingInterval);
                            } else {

                                hideLoadingModal();

                                showModal("ä¸Šå‚³éç¨‹å‡ºéŒ¯", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            }
                        } catch(err) {
                            console.error("ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
                            showModal("ç™¼é€éç¨‹å‡ºéŒ¯ï¼", () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        }
                    }

                    clickedButton = null; // reset
                });
                bindImageResultPreview(parts, result_form);
            }

            if (delete_form) {
                delete_form.addEventListener("submit", async function(e) {
                    e.preventDefault();

                    if (clickedButton && clickedButton.value === "resume") {

                        const formData = new FormData(delete_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        const res_delete = await fetch(`/record/resume_delete/{{ user_id }}/${current_patient_id}`, {
                            method: "POST",
                            body: formData
                        });
                        
                        const data_delete = await res_delete.json();
                            
                        if (!data_delete && !data_delete.status) {
                            throw new Error("é‚„åŸå½±åƒç™¼ç”ŸéŒ¯èª¤");
                            return;
                        }

                        if (data_delete.status === "ok") {
                            showModal(`é‚„åŸå½±åƒè³‡æ–™æˆåŠŸ!(id:${current_patient_id})`, () => {
                                window.location.href = data_delete.redirect;
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        }

                    } else if (clickedButton && clickedButton.value === "delete_confirm") {
                        const formData = new FormData(delete_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        const res_delete2 = await fetch(`/record/resume_delete/{{ user_id }}/${current_patient_id}`, {
                            method: "POST",
                            body: formData
                        });

                        const data_delete2 = await res_delete2.json();
                            
                        if (!data_delete2 && !data_delete2.status) {
                            throw new Error("åˆªé™¤å½±åƒç™¼ç”ŸéŒ¯èª¤");
                            return;
                        }

                        if (data_delete2.status === "ok") {
                            showModal(`åˆªé™¤å½±åƒè³‡æ–™æˆåŠŸ!(id:${current_patient_id})`, () => {
                                window.location.href = data_delete2.redirect;
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        }
                    } else if (clickedButton && clickedButton.value === "check_result") {
                        const formData = new FormData(delete_form);

                        if (clickedButton && clickedButton.name) {
                            formData.append(clickedButton.name, clickedButton.value);
                        }

                        for (const [key, value] of formData.entries()) {
                            console.log(key, value);

                            if (!value instanceof File && !value.name) {
                                showModal("è«‹å¡«å¦¥æ‰€æœ‰å¿…è¦æ¬„ä½", () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                                break;
                            }

                            if (key === "patient_id") {
                                current_patient_id = value;
                            }
                        }

                        openResultModal(delete_modal, formData, true);

                        const pollingInterval = 3000; // æ¯ 3 ç§’æŸ¥ä¸€æ¬¡
                        const maxRetries = 60; // æœ€å¤šè¼ªè©¢ 60 æ¬¡ (3 åˆ†é˜)
                        let attempts = 0;

                        const intervalId = setInterval(async () => {
                            try {
                                const res_delete = await fetch(`/record/retrieve_results/${current_patient_id}`, {
                                    method: "GET"
                                });

                                const data_delete = await res_delete.json();

                                if (data_delete.message === "not found") {
                                    clearInterval(intervalId);
                                    showModal(`æ²’æœ‰æ­¤ç—…æ‚£çš„è¾¨è­˜çµæœè³‡æ–™ (id=${current_patient_id})`, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                } else {
                                    const record_dict = data_delete.record_dict;

                                    const fields = [1, 2, 3, 4, 5, 6, 7, 8];
                                    fields.forEach((i) => {
                                        if (result_modal && record_dict[`img${i}`]) {
                                            result_modal.querySelector(`#upload_${i}`).src = record_dict[`img${i}`];
                                        }
                                    });
                                    clearInterval(intervalId);
                                }

                                // å¦‚æœè¶…éæœ€å¤§æ¬¡æ•¸é‚„æ²’å®Œæˆï¼Œå°±åœæ­¢
                                if (++attempts >= maxRetries) {
                                    clearInterval(intervalId);
                                    showModal("è¾¨è­˜é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦", () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                }
                            } catch(pollErr) {
                                clearInterval(intervalId);
                                showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                }, () => {
                                    console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                });
                            }
                        }, pollingInterval);

                        return;
                    }
                    clickedButton = null; // reset
                });
                bindImageResultPreview(parts, delete_form);
            }

            function startPolling(patient_ids, interval = 3000) {
                setInterval(() => checkInferenceForPatients(patient_ids), interval);
            }

            function openResultModal(current_modal, formData, next_result_page = false) {

                const currentModal = bootstrap.Modal.getInstance(current_modal);
                if (currentModal) currentModal.hide();

                const pollingInterval = 3000; // æ¯ 3 ç§’æŸ¥ä¸€æ¬¡
                const maxRetries = 60; // æœ€å¤šè¼ªè©¢ 60 æ¬¡ (3 åˆ†é˜)
                let attempts = 0;

                const prev_modal = result_modal.querySelector("#btnGoBack");
                if (prev_modal) {
                    
                    if (next_result_page) {
                        setTimeout(() => {
                        const resultModalEl = result_modal;
                        const resultModal = new bootstrap.Modal(resultModalEl);
                        resultModal.show();}, 400);
                    }

                    prev_modal.addEventListener("click", () => {
                        const currentModal = bootstrap.Modal.getInstance(result_modal);
                        if (currentModal) currentModal.hide();

                        setTimeout(() => {
                            const newModal = new bootstrap.Modal(current_modal);
                            newModal.show();
                        }, 400);
                        
                    });
                }

                // const upload_modal = result_modal.querySelector("#upload");

                /*
                if (upload_modal) {
                    upload_modal.addEventListener("click", () => {
                        const currentModal = bootstrap.Modal.getInstance(result_modal);
                        if (currentModal) currentModal.hide();

                        setTimeout(() => {
                            const newModal = new bootstrap.Modal(current_modal);
                            newModal.show();
                        }, 400);
                        
                    });
                }
                */

                /*
                if (upload_modal) {
                    upload_modal.addEventListener("click", async function(e) {

                        const pollingInterval = 3000; // æ¯ 3 ç§’æŸ¥ä¸€æ¬¡
                        const maxRetries = 60; // æœ€å¤šè¼ªè©¢ 60 æ¬¡ (3 åˆ†é˜)
                        let attempts = 0;
                        
                        const res_result = await fetch("/record/result/{{ user_id }}", {
                            method: "POST",
                            body: formData
                        });
                        const data_result = await res_result.json();

                        if (!data_result && !data_result.status) {
                            throw new Error("ä¸Šå‚³å½±åƒç™¼ç”ŸéŒ¯èª¤");
                            return;
                        }

                        if (data_result.status === "ok") {
                            const intervalId = setInterval(async () => {
                                try {
                                    const res_result1 = await fetch(`/record/upload_result/${current_patient_id}`, {
                                        method: "GET"
                                    });

                                    const data_result1 = await res_result1.json();

                                    if (data_result1.status === "done") {
                                        clearInterval(intervalId);

                                        showModal("ä¸Šå‚³å½±åƒå®Œæˆ", () => {
                                            console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                            window.location.href = data_result1.redirect;
                                        }, () => {
                                            console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                        });
                                        
                                    } else if (data_result1.status === "failed") {
                                        clearInterval(intervalId);

                                        showModal(`ä¸Šå‚³å½±åƒå¤±æ•—ï¼ŒéŒ¯èª¤è¨Šæ¯: ${data_result1.message}`, () => {
                                            console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                        }, () => {
                                            console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                        });
                                        return;
                                    }
                                } catch (pollErr) {
                                    clearInterval(intervalId);
                                    showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š OK");
                                    }, () => {
                                        console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                                    });
                                }
                            }, pollingInterval);
                        } else {
                            showModal("ä¸Šå‚³éç¨‹å‡ºéŒ¯", () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        }
                    });
                }
                */

                const intervalId = setInterval(async () => {
                    try {
                        const res_add6 = await fetch(`/record/retrieve_results/${current_patient_id}`, {
                            method: "GET"
                        });

                        const data_add6 = await res_add6.json();

                        if (data_add6.message === "not found") {
                            clearInterval(intervalId);
                            showModal(`æ²’æœ‰æ­¤ç—…æ‚£çš„è¾¨è­˜çµæœè³‡æ–™ (id=${current_patient_id})`, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        } else {
                            const record_dict = data_add6.record_dict;

                            const fields = [1, 2, 3, 4, 5, 6, 7, 8];
                            fields.forEach((i) => {
                                const img = document.getElementById(`upload_${i}`);
                                if (img && record_dict[`img${i}`]) {
                                    img.src = record_dict[`img${i}`];
                                }
                            });

                            clearInterval(intervalId);
                        }

                        // å¦‚æœè¶…éæœ€å¤§æ¬¡æ•¸é‚„æ²’å®Œæˆï¼Œå°±åœæ­¢
                        if (++attempts >= maxRetries) {
                            clearInterval(intervalId);
                            showModal("è¾¨è­˜é€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦", () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š OK");
                            }, () => {
                                console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                            });
                        }
                    } catch(pollErr) {
                        clearInterval(intervalId);
                        showModal("è¼ªè©¢éç¨‹å‡ºéŒ¯ï¼š" + pollErr.message, () => {
                            console.log("ä½¿ç”¨è€…é»æ“Š OK");
                        }, () => {
                            console.log("ä½¿ç”¨è€…é»æ“Š Cancel");
                        });
                    }
                }, pollingInterval);
            }

            startPolling(patient_ids);
        });
    </script>
</body>
</html>