<!-- templates/liff_account_manage.html -->
{% extends "liff_base.html" %}

{% block content %}
<div class="header">
    <div class="logo"></div>
    <div class="title">
      <h1>é†«å¿«æ‹</h1>
      <small>ç—…æ­·å½±åƒè¨˜éŒ„ç³»çµ±</small>
    </div>
</div>

<style>
  :root{
    --bg: #ccecf9;
    --panel: #ffffff;
    --panel-dark:#f3fbff;
    --brand:#1596d4;
    --brand-dark:#0f79ab;
    --text:#223244;
    --muted:#6b7b8a;
    --border:#d4e3ee;
    --head:#0b6d98;
    --head-t:#fff;
    --row:#f8fbfe;
    --ok:#10b981;
    --warn:#f59e0b;
    --danger:#ef4444;
    --blue:#338fd3;
    --green:#38b000;
    --red:#d64550;
    --gray:#eaf2f8;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    background: radial-gradient(ellipse at top,#d9f3ff 0%,var(--bg) 60%) fixed;
    font-family:"Segoe UI","Microsoft JhengHei",system-ui,-apple-system,sans-serif;
    color:var(--text);
  }

  /* header */
  .topbar{
    max-width:1100px; margin:24px auto 8px; padding:16px 20px;
    display:flex; align-items:center; gap:14px;
    border-radius:18px; background:linear-gradient(180deg,#e9f8ff,#d7f0ff);
    box-shadow:0 6px 18px rgba(20,80,120,.12);
    position:relative;
  }
  .logo{ width:64px;height:64px;border-radius:16px;background:#fff;display:grid;place-items:center; box-shadow:inset 0 0 0 2px #e5f4ff; }
  .logo::before{ content:"ğŸ…—"; font-size:30px; color:#0ea5e9; }
  .title h1{ margin:0; font-size:26px; color:#1686c1; font-weight:800; letter-spacing:.5px; }
  .title small{ display:block; color:#4ea7cf; margin-top:4px; font-weight:600; }
  .hi{
    position:absolute; right:18px; top:14px; color:#2b6f93; font-weight:700;
  }

  /* action bar */
  .card{ max-width:1100px; margin:0 auto 28px; background:var(--panel); border-radius:18px; box-shadow:0 10px 28px rgba(15,40,70,.10); overflow:hidden; }
  .bar{
    display:flex; justify-content:space-between; align-items:center; gap:12px;
    padding:10px; background:var(--panel-dark); border-bottom:1px solid var(--border);
  }
  .btn{ border:0; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; transition:.15s ease; }
  .btn:active{ transform:translateY(1px) }
  .btn-chip{ background:#fff; border:1px solid var(--border); color:#275a74; }
  .btn-green{ background:#e8fbef; color:#137a55; }
  .btn-red{ background:#ffe8ea; color:#a92c37; }
  .btn-blue{ background:#e7f3ff; color:#0f6fb1; }
  .btn .i{ margin-right:6px }
  .group{ display:flex; gap:8px; align-items:center; }

  /* table */
  .table-wrap{ padding:10px 14px 14px; }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  thead th{ background:var(--head); color:var(--head-t); padding:10px 8px; text-align:left; font-weight:800; }
  tbody td{ padding:10px 8px; border-bottom:1px solid #eef5fb; }
  tbody tr:nth-child(odd){ background:var(--row); }
  tbody tr:hover{ background:#eef9ff; }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .badge-ok{ background:#e7fbf4; color:#11795d; }
  .badge-off{ background:#eef2f7; color:#5b6b7a; }
  .role{ font-weight:700; color:#3c7aa3; }

  /* pagination */
  .pagination{ display:flex; gap:6px; justify-content:center; align-items:center; padding:6px 0 6px; }
  .pager{ width:32px;height:32px; display:grid; place-items:center; border-radius:8px; border:1px solid var(--border); background:#fff; color:#156c9d; cursor:pointer; transition:.15s ease; }
  .pager.active{ background:var(--brand); color:#fff; border-color:transparent; font-weight:800; }
  .pager:hover{ transform:translateY(-1px) }

  /* footer */
  .footer{ text-align:center; color:#6aa8c8; font-size:13px; padding:8px 0 28px; }

  /* responsive */
  @media (max-width:880px){
    .bar{ flex-wrap:wrap; }
    .group:last-child{ width:100%; justify-content:flex-start; }
    thead{ display:none; }
    table, tbody, tr, td{ display:block; width:100%; }
    tbody tr{ border:1px solid var(--border); border-radius:12px; margin-bottom:10px; padding:6px 6px; }
    tbody td{ border:0; padding:6px 6px; }
    tbody td::before{ content:attr(data-th) "ï¼š"; font-weight:700; color:#466a84; margin-right:6px; }
  }

  /* ===== Modal åŸºæœ¬æ¨£å¼ï¼ˆåƒ…ä½œç”¨æ–¼ #curAccountModalï¼‰ ===== */
#curAccountModal .modal-dialog{
  max-width: 720px;
}

#curAccountModal .modal-content{
  border: 0;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(15,40,70,.25);
  background: #fff;
}

/* è‹¥ form æœ‰ç”¨ .cardï¼Œé¿å…å‡ºç¾é›™å±¤å¡ç‰‡å¤–è§€ */
#curAccountModal #account_form.card{
  background: transparent;
  border: 0;
  box-shadow: none;
  padding: 0;
}

/* æ¨™é ­èˆ‡æ¨™é¡Œ */
#curAccountModal .custom-modal-header{
  padding: 16px 20px;
  background: linear-gradient(135deg, #e9f8ff 0%, #d7f0ff 100%);
  border-bottom: 1px solid #d4e3ee;
}

#curAccountModal .modal-title{
  display: flex;
  align-items: center;
  gap: 10px;
  color: #1686c1;
  font-weight: 800;
  letter-spacing: .2px;
}

/* æ¨™é¡Œæ·¡å…¥å‹•æ…‹ï¼ˆFont Awesome çš„ fa-beat æœƒç…§å¸¸é‹ä½œï¼Œé€™æ˜¯é¡å¤–çš„æ•´é«”æ¨™é¡Œé€²å ´ï¼‰ */
@keyframes titleFloatIn{
  from{ opacity: 0; transform: translateY(6px); }
  to{   opacity: 1; transform: translateY(0); }
}

#curAccountModal .animated-title{
  animation: titleFloatIn .35s ease both;
}

#curAccountModal .modal-body{
  padding: 18px 20px 6px;
}

/* Label èˆ‡è¡¨å–®æ§åˆ¶é … */
#curAccountModal .form-label{
  font-weight: 700;
  font-size: .9rem;
  color: #466a84;
}

#curAccountModal .form-control,
#curAccountModal .form-select{
  border-radius: 12px;
  border: 1px solid #d4e3ee;
  padding: 10px 12px;
  box-shadow: none;
  transition: border-color .15s ease, box-shadow .15s ease;
}

#curAccountModal .form-control:focus,
#curAccountModal .form-select:focus{
  border-color: #1596d4;
  box-shadow: 0 0 0 .2rem rgba(21,150,212,.15);
}

/* åº•éƒ¨æŒ‰éˆ•å€ */
#curAccountModal .modal-content .mt-3{
  padding: 0 20px 20px;
}

#curAccountModal .btn-primary{
  background: #1596d4;
  border-color: #1596d4;
}
#curAccountModal .btn-primary:hover{
  background: #0f79ab;
  border-color: #0f79ab;
}
#curAccountModal .btn-secondary{
  background: #eaf2f8;
  color: #275a74;
  border-color: #eaf2f8;
}
#curAccountModal .btn-secondary:hover{
  background: #dbeaf4;
  color: #1f516a;
}

/* å½ˆå‡ºå‹•ç•«ï¼ˆè¦†è“‹ Bootstrap é è¨­ fade çš„ä½ç§»ï¼‰ */
#curAccountModal.modal.fade .modal-dialog{
  transform: translateY(24px);
  transition: transform .25s ease, opacity .25s ease;
}
#curAccountModal.modal.show .modal-dialog{
  transform: none;
}

/* å°è¢å¹•å„ªåŒ– */
@media (max-width: 576px){
  #curAccountModal .modal-dialog{ margin: .75rem; }
  #curAccountModal .modal-title{ font-size: 1rem; }
}
</style>

<body>
    <div class="card">
        <div class="bar">
        <div class="group">
            <button class="btn btn-chip" id="btn-setting"><span class="i">âš™ï¸</span>ç³»çµ±è¨­å®š</button>
            <button class="btn btn-chip" id="btn-account"><span class="i">ğŸ§©</span>å¸³è™Ÿç®¡ç†</button>
        </div>
        <div class="group">
            <!-- <button class="btn btn-green" id="btn-gen"><span class="i">ğŸ”</span>ç”¢ç”Ÿå¯†ç¢¼</button> -->
            <!-- <button class="btn btn-red" id="btn-logout"><span class="i">ğŸšª</span>ç™»å‡º</button> -->
            <!--<button class="btn btn-blue" id="btn-add"><span class="i">ğŸ§‘â€ğŸ’¼</span>æ–°å¢ä½¿ç”¨è€…</button>-->
            <button class="btn btn-blue" id="btn-add" data-bs-toggle="modal" data-bs-target="#NewAccountModal"><span class="i">ğŸ§‘â€ğŸ’¼</span>æ–°å¢ä½¿ç”¨è€…</button>
        </div>
        </div>

        <div class="table-wrap">
        <table id="userTable" aria-label="ä½¿ç”¨è€…æ¸…å–®">
            <thead>
            <tr>
                <th style="width:9%">å¸³è™Ÿ</th>
                <th style="width:8%">å§“å</th>
                <th style="width:8%">å¯†ç¢¼</th>
                <th style="width:15%">å–®ä½</th>
                <th style="width:12%">èº«åˆ†</th>
                <th style="width:6%">ç‹€æ…‹</th>
                <th style="width:20%">å‚™è¨»</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <div class="footer">
        <a href="#" style="text-decoration:none; font-weight:800; color:#3aa3d1">Mi-tech</a> Copyright Â© 2019
    </div>

    <script>
        /* ---- demo data ---- */
        const users = {{ all_account_dict | tojson }}

        console.log("users:", users);

        /*
        [
        {account:"66666666", name:"BBBBBB", unit:"BBBè¨ºæ‰€", role:"", status:"å•Ÿç”¨", note:"test"},
        {account:"55555555", name:"AAAA", unit:"AAAAè¨ºæ‰€", role:"", status:"å•Ÿç”¨", note:"dsafasdfatad asdf as fas cfas"},
        {account:"44444444", name:"CCCCCCCC", unit:"CCCCCCCC", role:"", status:"å•Ÿç”¨", note:"(fjsaljfewjasldfjaxsljefjeiadjfj)"},
        {account:"test123",   name:"æ¸¬è©¦è³¬è™Ÿ", unit:"æ¸¬è©¦", role:"", status:"å•Ÿç”¨", note:""},
        {account:"user1",     name:"test", unit:"mit", role:"", status:"å•Ÿç”¨", note:""},
        {account:"admin",     name:"admin", unit:"1234", role:"ç®¡ç†", status:"å•Ÿç”¨", note:""},
        {account:"MiAdmin",   name:"ç®¡ç†è€…", unit:"ç®¡ç†", role:"ç®¡ç†", status:"å•Ÿç”¨", note:""},
        {account:"test1",     name:"ç‹å¤§æ˜", unit:"æ¸¬è©¦", role:"", status:"å•Ÿç”¨", note:"æ¸¬è©¦"},
        {account:"mitech",    name:"mit", unit:"dental", role:"", status:"å•Ÿç”¨", note:""},
        {account:"mit1",      name:"tst", unit:"", role:"", status:"å•Ÿç”¨", note:""},
        {account:"test2",     name:"è¶™å°ç¾", unit:"æ¸¬è©¦å–®ä½", role:"", status:"å•Ÿç”¨", note:"æ¸¬è©¦å…§å®¹"},
        {account:"test3",     name:"æ—å¤§ç‚º", unit:"æ¸¬è©¦å–®ä½", role:"", status:"å•Ÿç”¨", note:""},
        ];
        */

        const pageSize = 8;
        let currentPage = 1;

        function renderTable(page=1)
        {
            const tbody = document.getElementById('tbody');
            const start = (page-1)*pageSize, end = start+pageSize;
            const pageRows = users.slice(start, end);

            console.log("pageRows:", pageRows);

            tbody.innerHTML = pageRows.map(u => {
                const statusBadge = u.status === 'activated'
                ? '<span class="badge badge-ok">å•Ÿç”¨</span>'
                : '<span class="badge badge-off">åœç”¨</span>';

                const role = u.role ? `<span class="role">${u.role}</span>` : '';

                return `
                <tr>
                    <td data-th="å¸³è™Ÿ">${u.account}</td>
                    <td data-th="å§“å">${u.name}</td>
                    <td data-th="å¯†ç¢¼">${u.password}</td>
                    <td data-th="å–®ä½">${u.unit || ''}</td>
                    <td data-th="èº«åˆ†">${role}</td>
                    <td data-th="ç‹€æ…‹">${statusBadge}</td>
                    <td data-th="å‚™è¨»">${u.note || ''}</td>
                    <td data-yj="ä¿®æ”¹">
                      <button type="button" class="modify_btn btn btn-sm btn-primary"
                              data-bs-toggle="modal" data-bs-target="#curAccountModal"
                              data-f-account="${u.account ?? ''}"
                              data-f-name="${u.name ?? ''}"
                              data-f-password="${u.password ?? ''}"
                              data-f-unit="${u.unit ?? ''}"
                              data-f-role="${u.role ?? ''}"
                              data-f-status="${u.status ?? ''}"
                              data-f-note="${u.note ?? ''}">
                        ä¿®æ”¹
                      </button>
                    </td>
                </tr>`;

            }).join('');

            // pagination
            const totalPages = Math.max(1, Math.ceil(users.length / pageSize));
            const pager = document.getElementById('pagination');
            const mkBtn = (label, pageNum, active=false, disabled=false) =>
                `<button class="pager ${active?'active':''}" ${disabled?'disabled':''} data-page="${pageNum}">${label}</button>`;
                
            let html = '';
            html += mkBtn('Â«', Math.max(1, page-1), false, page===1);
            
            for(let i=1;i<=totalPages;i++)
            { 
                html += mkBtn(i, i, i===page); 
            }
            
            html += mkBtn('Â»', Math.min(totalPages, page+1), false, page===totalPages);

            pager.innerHTML = html;
            pager.querySelectorAll('.pager').forEach(b=>{
                b.addEventListener('click', e=>{
                    
                    currentPage = Number(e.currentTarget.getAttribute('data-page'));
                    if (users) {
                        //renderTable(currentPage);
                    }
                });
            });
        }

        /* demo actions */
        /*
        document.getElementById('btn-gen').addEventListener('click', ()=>alert('å·²ç‚ºé¸å–çš„ä½¿ç”¨è€…ç”¢ç”Ÿæ–°å¯†ç¢¼ï¼ˆç¤ºæ„ï¼‰ã€‚'));
        document.getElementById('btn-logout').addEventListener('click', ()=>alert('å·²ç™»å‡ºï¼ˆç¤ºæ„ï¼‰ã€‚'));
        document.getElementById('btn-add').addEventListener('click', ()=>alert('é–‹å•Ÿã€Œæ–°å¢ä½¿ç”¨è€…ã€è¦–çª—ï¼ˆç¤ºæ„ï¼‰ã€‚'));
        */

        if (users != {}) {
            renderTable(currentPage);
        }
    </script>
</body>

<div class="modal fade" id="curAccountModal" tabindex="-1" aria-labelledby="curAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" action="/record/confirm_account" class="card p-4" id="account_form">
                <div class="modal-header custom-modal-header">
                    <h5 class="modal-title animated-title" id="curAccountModalLabel">
                        <i class="fas fa-edit fa-beat"></i> ç·¨è¼¯ä½¿ç”¨è€…
                    </h5>
                </div>

                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">å¸³è™Ÿ</label>
                    <input name="f_account" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å§“å</label>
                    <input name="f_name" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å¯†ç¢¼</label>
                    <input name="f_password" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å–®ä½</label>
                    <input name="f_unit" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">èº«åˆ†</label>
                    <select name="f_role" class="form-select">
                      <option value="system manager">ç³»çµ±ç®¡ç†è€…</option>
                      <option value="resource manager">è³‡æºç®¡ç†è€…</option>
                      <option value="tester">è©¦ç”¨è€…</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label">ç‹€æ…‹</label>
                    <select name="f_status" class="form-select">
                      <option value="activated">å•Ÿç”¨</option>
                      <option value="deactivated">åœç”¨</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea name="f_note" class="form-control" rows="3"></textarea>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2 justify-content-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="NewAccountModal" tabindex="-1" aria-labelledby="NewAccountModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" action="/record/confirm_add_account" class="card p-4" id="add_account_form">
                <div class="modal-header custom-modal-header">
                    <h5 class="modal-title animated-title" id="NewAccountModalLabel">
                        <i class="fas fa-edit fa-beat"></i> æ–°å¢ä½¿ç”¨è€…
                    </h5>
                </div>

                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">å¸³è™Ÿ</label>
                    <input name="f_account" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å§“å</label>
                    <input name="f_name" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å¯†ç¢¼</label>
                    <input name="f_password" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å–®ä½</label>
                    <input name="f_unit" class="form-control">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">èº«åˆ†</label>
                    <select name="f_role" class="form-select">
                      <option value="system manager">ç³»çµ±ç®¡ç†è€…</option>
                      <option value="resource manager">è³‡æºç®¡ç†è€…</option>
                      <option value="tester">è©¦ç”¨è€…</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label">ç‹€æ…‹</label>
                    <select name="f_status" class="form-select">
                      <option value="activated">å•Ÿç”¨</option>
                      <option value="deactivated">åœç”¨</option>
                    </select>
                  </div>
                  <div class="col-12">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea name="f_note" class="form-control" rows="3"></textarea>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2 justify-content-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                  <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
