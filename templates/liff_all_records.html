
<!-- templates/liff_change_pwd.html -->
{% extends "liff_base.html" %}

{% block content %}

<style>
  :root{
    --bg: #ccecf9;
    --panel: #ffffff;
    --panel-dark: #f3fbff;
    --brand: #1596d4;
    --brand-dark:#0f79ab;
    --text:#223244;
    --muted:#6b7b8a;
    --border:#d4e3ee;
    --table-head:#0b6d98;
    --table-head-text:#fff;
    --row-alt:#f8fbfe;
    --warn:#f59e0b;
    --ok:#10b981;
    --danger:#ef4444;
  }
  *{box-sizing: border-box}
  body{
    margin:0;
    background: radial-gradient(ellipse at top,#d9f3ff 0%,var(--bg) 60%) fixed;
    font-family: "Segoe UI", "Microsoft JhengHei", system-ui, -apple-system, sans-serif;
    color:var(--text);
  }

  /* header */
  .header{
    max-width: 1100px;
    margin: 24px auto 8px;
    padding: 16px 20px;
    display:flex;
    align-items:center;
    gap:14px;
    border-radius: 18px;
    background: linear-gradient(180deg,#e9f8ff, #d7f0ff);
    box-shadow: 0 6px 18px rgba(20,80,120,.12);
  }
  .logo{
    width:64px;height:64px;border-radius:16px;
    background: #fff;
    display:grid;place-items:center;
    box-shadow: inset 0 0 0 2px #e5f4ff;
  }
  .logo::before{
    content:"ğŸ…—"; font-size:30px; color:#0ea5e9;
  }
  .title{
    line-height:1.1
  }
  .title h1{
    margin:0; font-size:26px; letter-spacing:.5px; color:#1686c1; font-weight:800;
  }
  .title small{
    display:block; color:#4ea7cf; margin-top:4px; font-weight:600;
  }

  /* tabs */
  .tabs{
    display:flex; gap:8px; padding:10px; background:var(--panel-dark); border-bottom:1px solid var(--border);
  }
  .tab{
    border:1px solid var(--border);
    background:#fff; color:var(--brand-dark);
    padding:8px 14px; border-radius:10px; font-weight:700; cursor:pointer;
    transition:.15s ease;
  }
  .tab.active{ background:var(--brand); color:#fff; border-color:transparent; box-shadow: 0 4px 10px rgba(21,150,212,.25); }
  .tab:hover{ transform: translateY(-1px) }

  /* filters */
  .filters{
    display:grid;
    grid-template-columns: 1.3fr 1fr 1fr 1fr auto;
    gap:10px; padding:14px 14px 10px;
    background: #f6fbff;
    border-bottom:1px solid var(--border);
  }
  .field{ display:flex; align-items:center; gap:6px; }
  .field label{ font-size:12px; color:var(--muted); white-space:nowrap; }
  .input, select{
    width:100%; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff; color:var(--text);
    outline:none;
  }
  .btn-row{ display:flex; gap:8px; justify-content:flex-end; align-items:center; }
  .btn{ padding:8px 12px; border:0; border-radius:10px; font-weight:700; cursor:pointer; transition:.15s ease; }
  .btn:active{ transform: translateY(1px) }
  .btn-primary{ background:var(--brand); color:#fff; }
  .btn-secondary{ background:#eaf6ff; color:var(--brand-dark); }
  .btn-warning{ background:#fff4e5; color:#b4690e; }
  .btn-danger{ background:#ffe5e7; color:#c0363b; }

  /* table */
  .table-wrap{ padding: 8px 14px 16px; }
  table{ width:100%; border-collapse: collapse; font-size:14px; overflow:clip; }
  thead th{
    background: var(--table-head);
    color: var(--table-head-text);
    text-align:left; padding:10px 8px; font-weight:800;
    position: sticky; top:0; z-index:1;
  }
  tbody td{ padding:10px 8px; border-bottom:1px solid #eef5fb; }
  tbody tr:nth-child(odd){ background: var(--row-alt); }
  tbody tr:hover{ background:#eef9ff; }
  .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700; }
  .badge-ok{ background:#e7fbf4; color:#11795d; }
  .badge-off{ background:#eef2f7; color:#5b6b7a; }
  .role{ font-weight:700; color:#3c7aa3; }

  .badge{
    display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700;
  }
  .badge.gray{ background:#eef2f7; color:#5b6b7a; }
  .badge.green{ background:#e7fbf4; color:#11795d; }

  /* pagination */
  .pagination{
    display:flex; gap:6px; justify-content:center; align-items:center; padding:6px 0 6px;
  }
  .pager{
    width:32px; height:32px; display:grid; place-items:center; border-radius:8px;
    border:1px solid var(--border); background:#fff; color:var(--brand-dark); cursor:pointer;
    transition:.15s ease;
  }
  .pager.active{ background:var(--brand); color:#fff; border-color:transparent; font-weight:800; }
  .pager:hover{ transform: translateY(-1px) }

  /* footer */
  .footer{
    text-align:center; color:#6aa8c8; font-size:13px; padding:8px 0 28px;
  }

  /* responsive */
  @media (max-width: 880px){
    .filters{ grid-template-columns: 1fr 1fr; }
    .btn-row{ grid-column: 1 / -1; justify-content:flex-start; }
    thead{ display:none; }
    table, tbody, tr, td{ display:block; width:100%; }
    tbody tr{ border:1px solid var(--border); border-radius:12px; margin-bottom:10px; padding:6px 6px; }
    tbody td{ border:0; padding:6px 6px; }
    tbody td::before{
      content: attr(data-th) "ï¼š";
      font-weight:700; color:#466a84; margin-right:6px;
    }

  /* header */
  .topbar{
    max-width:1100px; margin:24px auto 8px; padding:16px 20px;
    display:flex; align-items:center; gap:14px;
    border-radius:18px; background:linear-gradient(180deg,#e9f8ff,#d7f0ff);
    box-shadow:0 6px 18px rgba(20,80,120,.12);
    position:relative;
  }

    /* action bar */
  .card{ max-width:1100px; margin:0 auto 28px; background:var(--panel); border-radius:18px; box-shadow:0 10px 28px rgba(15,40,70,.10); overflow:hidden; }
  
  .bar{
    display:flex; justify-content:space-between; align-items:center; gap:12px;
    padding:10px; background:var(--panel-dark); border-bottom:1px solid var(--border);
  }
  .btn{ border:0; padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer; transition:.15s ease; }
  .btn:active{ transform:translateY(1px) }
  .btn-chip{ background:#fff; border:1px solid var(--border); color:#275a74; }
  .btn-green{ background:#e8fbef; color:#137a55; }
  .btn-red{ background:#ffe8ea; color:#a92c37; }
  .btn-blue{ background:#e7f3ff; color:#0f6fb1; }
  .btn .i{ margin-right:6px }
  .group{ display:flex; gap:8px; align-items:center; }

  }
</style>

<body>
    <!-- Header -->
    <div class="header">
        <div class="logo"></div>
        <div class="title">
        <h1>é†«å¿«æ‹</h1>
        <small>ç—…æ­·å½±åƒè¨˜éŒ„ç³»çµ±</small>
        </div>
    </div>

    <!-- Main Card -->
    <form method="POST" enctype="multipart/form-data" action="/export_data" class="modal-content" id="export_form">
      <div class="card">
        <!-- Filters -->
        <div class="filters">
        <div class="field">
            <label>ä¸Šå‚³æ—¥æœŸ</label>
            <input class="input" type="text" id="dateRange" placeholder="2024/06/24-2024/09/24" value="{{ today_date }}"/>
        </div>
        <div class="field">
            <label>ä¸Šå‚³å¸³è™Ÿ</label>
            <select id="uploader">
            <option value="all">å…¨éƒ¨</option>
            <option selected>test1</option>
            <option>nurse_a</option>
            <option>doctor_b</option>
            </select>
        </div>
        <div class="field">
            <label>åˆ†æç‹€æ…‹</label>
            <select id="status">
            <option value="all">å…¨éƒ¨</option>
            <option value="done">å·²å®Œæˆ</option>
            <option value="pending">æœªå®Œæˆ</option>
            <option value="not_started">æœªé–‹å§‹</option>
            </select>
        </div>
        <div class="field">
            <label>è¾¨è­˜åˆ†é¡çµæœæ¨™ç±¤</label>
            <select id="category">
                <option value="all">å…¨éƒ¨</option>
                <option value="none"> å¥åº·ç„¡ç—…ç¶</option>
                <option value="green">ç¶ ç‡ˆ (è¼•å¾®ç­‰ç´š)</option>
                <option value="yellow">é»ƒç‡ˆ (ç–‘ä¼¼åš´é‡ç­‰ç´š)</option>
                <option value="red">ç´…ç‡ˆ (åš´é‡ç­‰ç´š)</option>
            </select>
        </div>
        <div class="btn-row">
            <!-- <button class="btn btn-secondary" id="btn-clean">æ¸…é™¤</button> -->
            <button type="button" class="btn btn-warning"> åŒ¯å…¥ </button>
            <button type="button" class="btn btn-primary" id="btn-search">æŸ¥è©¢</button>
            <button type="submit" id="export_data" name="action" value="export" class="btn btn-danger"> åŒ¯å‡º </button>
        </div>
        </div>
        
        <!-- Tabs -->
        <!--
        <div class="tabs">
        <button class="tab active" id="tab-upload">ä¸Šå‚³ç´€éŒ„</button>
        <button class="tab" id="tab-target">ç›®æ¨™æŸ¥è©¢</button>
        </div>
        -->

        <!-- Table -->
        <div class="table-record-wrap">
        <table id="dataTable" aria-label="ä¸Šå‚³ç´€éŒ„è¡¨æ ¼">
            <thead>
            <tr>
                <th style="width:16%">å½±åƒæ¡ˆä¾‹ç·¨è™Ÿ</th>
                <th style="width:16%">å»ºç«‹æ—¥æœŸ</th>
                <th style="width:10%">å½±åƒæ•¸</th>
                <th style="width:17%">ä¸Šå‚³æ—¥æœŸ</th>
                <th style="width:12%">ä¸Šå‚³äººå“¡</th>
                <th style="width:12%">åˆ†æç‹€æ…‹</th>
                <th>å‚™è¨»</th>
                <th></th>
            </tr>
            </thead>
            <tbody id="tbody"></tbody>
        </table>

        <div class="pagination" id="pagination"></div>
        </div>
      </div>
    </form>

    <div class="footer">
        <a href="#" style="text-decoration:none; font-weight:800; color:#3aa3d1">Mi-tech</a> Copyright Â© 2019
    </div>

    <script>
        /* ---- demo data + simple pager/filter ---- */
        const rows = {{ grouped_records | tojson }}

        console.log("rows:", rows)
        /*
        [
            {created:"2024-09-23 17:36:33", case:"240923-173633", count:8, uploaded:"2024-09-23 17:39:27", user:"test1", status:"pending"},
            {created:"2024-09-23 15:38:35", case:"240923-153835", count:9, uploaded:"2024-09-23 15:49:20", user:"test1", status:"pending"},
            {created:"2024-09-23 14:59:40", case:"240923-145940", count:8, uploaded:"2024-09-23 15:05:57", user:"test1", status:"pending"},
            {created:"2024-09-16 17:15:57", case:"240916-171557", count:9, uploaded:"2024-09-16 16:59:56", user:"test1", status:"done"},
            {created:"2024-09-16 16:03:49", case:"240916-160349", count:9, uploaded:"2024-09-16 16:06:36", user:"test1", status:"done"},
            {created:"2024-08-13 15:27:33", case:"240813-152733", count:9, uploaded:"2024-08-13 15:23:32", user:"test1", status:"done"},
            {created:"2024-08-05 17:06:30", case:"240805-170630", count:8, uploaded:"2024-08-06 14:17:04", user:"test1", status:"pending"},
        ];
        */

        const pageSize = 5;
        let currentPage = 1;

        function isWithinDateRange(dateStr, startStr, endStr) {
            const date = new Date(dateStr);
            const start = new Date(startStr);
            const end = new Date(endStr);

            return date >= start && date <= end;
        }

        function applyFilters(){
            const daterange = document.getElementById('dateRange').value.trim();
            const uploader = document.getElementById('uploader').value.trim();
            const status = document.getElementById('status').value;
            const category = document.getElementById('category').value;

            if (rows.length != 0) {
                return rows.filter(r =>
                    (daterange ? isWithinDateRange(r.uploaded.split(' ')[0], daterange.replace(/\//g, "-").split('~')[0].trim(), daterange.replace(/\//g, "-").split('~')[1].trim()) : true) &&
                    (uploader ? r.user === uploader || uploader === "all" : true) &&
                    (status ? r.status === status || status === "all" : true) && 
                    (category ? r.category === category || category === "all" : true)
                );
            } else {
                return rows;
            }
        }

        function renderTable(page=1) {
            const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
            const data = applyFilters();
            const start = (page-1)*pageSize, end = start+pageSize;
            const pageRows = data.slice(start, end);
            // const pageRows = rows.slice(start, end);
            const tbody = document.getElementById('tbody');
            tbody.innerHTML = pageRows.map(r => {
                const badge = r.status === 'done'
                ? '<span class="badge green">å·²å®Œæˆ</span>'
                : '<span class="badge gray">æœªå®Œæˆ</span>';
                return `
                <tr>
                    <td data-th="å½±åƒæ¡ˆä¾‹ç·¨è™Ÿ">${r.case}</td>
                    <td data-th="å»ºç«‹æ—¥æœŸ">${r.created}</td>                    
                    <td data-th="å½±åƒæ•¸">${r.count}</td>
                    <td data-th="ä¸Šå‚³æ—¥æœŸ">${r.uploaded}</td>
                    <td data-th="ä¸Šå‚³äººå“¡">${r.user}</td>
                    <td data-th="åˆ†æç‹€æ…‹">${badge}</td>
                    <td data-th="å‚™è¨»">${r.notes || ''}</td>
                    <td data-yj="æŸ¥çœ‹">
                      <button type="button" class="view_btn btn btn-sm btn-primary"
                              data-bs-toggle="modal" data-bs-target="#viewAllRecordModal"
                              data-f-createtime="${r.created ?? ''}"
                              data-f-case="${r.case ?? ''}"
                              data-f-count="${r.count ?? ''}"
                              data-f-uploadtime="${r.uploaded ?? ''}"
                              data-f-user="${r.user ?? ''}"
                              data-f-status="${r.status ?? ''}"
                              data-f-notes="${r.notes ?? ''}">
                        æŸ¥çœ‹
                      </button>
                    </td>
                </tr>`;
            }).join('');

            // pagination
            const pager = document.getElementById('pagination');
            const contentDiv = document.getElementById('content');

            // æ¸²æŸ“å…§å®¹
            function renderContent() {
              const start = (currentPage - 1) * pageSize;
              const end = start + pageSize;
              const data = applyFilters();
              const pageData = data.slice(start, end);

              contentDiv.innerHTML = "<ul>" + pageData.map(u => "<li>" + u + "</li>").join("") + "</ul>";
            }

            // æ¸²æŸ“åˆ†é æŒ‰éˆ•
            function renderPagination() {
              const data = applyFilters();
              const totalPages = Math.max(1, Math.ceil(data.length / pageSize));
              let html_page = '';

              for (let i = 1; i <= totalPages; i++) {
                html_page += `<button class="pager ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
              }

              let html = `
                <div class="pagination">
                  <button class="pager prev ${currentPage === 1 ? 'disabled' : ''}">Prev</button>
                  ${html_page}
                  <button class="pager next ${currentPage === totalPages ? 'disabled' : ''}">Next</button>
                </div>
              `;

              pager.innerHTML = html;

              // ç¶å®šäº‹ä»¶
              pager.querySelectorAll(".pager").forEach(btn => {
                btn.addEventListener("click", () => {
                  const page = btn.dataset.page;
                  if (page) {
                    currentPage = parseInt(page);
                    update();
                  } else if (btn.classList.contains("prev") && currentPage > 1) {
                    currentPage--;
                    update();
                  } else if (btn.classList.contains("next") && currentPage < totalPages) {
                    currentPage++;
                    update();
                  }
                });
              });
            }
        }

        function update() {
            renderContent();
            renderPagination();
        }

        document.getElementById('btn-search').addEventListener('click', ()=>renderTable(1));
        /*
        document.getElementById('btn-clean').addEventListener('click', ()=>{
            document.getElementById('uploader').value = '';
            document.getElementById('status').value = '';
            document.getElementById('dateRange').value = '';
            renderTable(1);
        });
        */

        const totalPages = Math.max(1, Math.ceil(rows.length / pageSize));
        const uploader = document.getElementById('uploader');
        const data = applyFilters();

        html = "<option value=\"all\">å…¨éƒ¨</option>";

        if (rows.length != 0) {
            for (let i = 0; i < totalPages; i++) {
                html += "<option value=\"" + rows[i].user + "\">" + rows[i].user + "</option>";
            }
        }

        uploader.innerHTML = html;

        // fake tab switching (åƒ…ç¤ºæ„)
        /*
        document.getElementById('tab-upload').addEventListener('click', ()=>{
            document.getElementById('tab-upload').classList.add('active');
            document.getElementById('tab-target').classList.remove('active');
        });
        document.getElementById('tab-target').addEventListener('click', ()=>{
            document.getElementById('tab-target').classList.add('active');
            document.getElementById('tab-upload').classList.remove('active');
        });
        */

        renderTable(currentPage);
    </script>
</body>

<div class="modal fade" id="viewAllRecordModal" tabindex="-1" aria-labelledby="viewAllRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" enctype="multipart/form-data" class="card p-4" id="all_record_form">
                <div class="modal-header custom-modal-header">
                    <h5 class="modal-title animated-title" id="viewAllRecordModalLabel">
                        <i class="fas fa-edit fa-beat"></i> æŸ¥çœ‹ç—…æ­·ç´€éŒ„
                    </h5>
                </div>

                <div class="modal-body">
                  <div class="mb-3">
                    <label class="form-label">å»ºç«‹æ—¥æœŸ</label>
                    <input name="f_createtime" class="form-control" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å½±åƒæ¡ˆä¾‹ç·¨è™Ÿ</label>
                    <input name="f_case" class="form-control" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">å½±åƒæ•¸</label>
                    <input name="f_count" class="form-control" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">ä¸Šå‚³æ—¥æœŸ</label>
                    <input name="f_uploadtime" class="form-control" readonly>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">ä¸Šå‚³äººå“¡</label>
                    <input name="f_user" class="form-control" readonly>
                  </div>
                  <div class="col-6">
                    <label class="form-label">åˆ†æç‹€æ…‹</label>
                    <input name="f_status" class="form-control" readonly>
                  </div>
                  <div class="col-12">
                    <label class="form-label">å‚™è¨»</label>
                    <textarea name="f_notes" class="form-control" rows="3" readonly></textarea>
                  </div>
                </div>
                <div class="mt-3 d-flex gap-2 justify-content-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
