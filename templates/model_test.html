<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title> æ¨¡å‹æ¸¬è©¦é  </title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  {% extends "base.html" %}
  {% block content %}
  <!-- Bootstrap å°è¦½åˆ— -->
  <div id="instruction-guide" style="margin-bottom: 30px;">

  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">ğŸ§  æ¨¡å‹æ¸¬è©¦å¹³å°</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="åˆ‡æ›å°èˆª">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload" type="button" role="tab" aria-controls="upload" aria-selected="true">
              ğŸ“¤ ä¸Šå‚³åœ–ç‰‡
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="test-tab" data-bs-toggle="tab" data-bs-target="#test" type="button" role="tab" aria-controls="test" aria-selected="false">
              ğŸ§ª æ¸¬è©¦æ¨¡å‹
            </button>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Tab å…§å®¹ -->
  <div class="container mt-4">
    <div class="tab-content">

      <!-- ä¸Šå‚³åœ–ç‰‡åˆ†é  -->
      <div class="tab-pane fade show active col-md-4 mb-4" id="upload" role="tabpanel" aria-labelledby="upload-tab">
        <form id="uploadForm" enctype="multipart/form-data">
          <h3>ğŸ“¸ è«‹ä¸Šå‚³å…«å€‹å£è…”æ–¹ä½å½±åƒï¼š</h3>
          <div style="display: flex; flex-wrap: wrap; gap: 20px;">
            {% set parts = [
              ("1", "ä¸Šç‰™é½¦"),
              ("2", "ä¸Šé¡"),
              ("3", "å³é °"),
              ("4", "èˆŒå³"),
              ("5", "èˆŒå·¦"),
              ("6", "å·¦é °"),
              ("7", "èˆŒä¸‹"),
              ("8", "ä¸‹ç‰™é½¦")
            ] %}

            {% for code, label in parts %}
            <div style="width: 140px; text-align: center;">
              <img src="/static/guide/{{ code }}.png" alt="{{ label }}" style="width: 100%; border-radius: 6px; margin-bottom: 5px;">
              <div style="font-size: 14px; font-weight: 500;">{{ label }}</div>
              <!--<input type="file" name="{{ code }}" id="upload_{{ code }}" accept="image/*" required style="display: none;">-->
              <input type="file" name="{{ code }}" id="upload_{{ code }}" style="display: none;">
              <button type="button" id="SelectBtn_{{ code }}">é¸æ“‡åœ–ç‰‡</button>
            </div>
            {% endfor %}
          </div>
          <br>
          <button type="submit" id="UploadBtn">ä¸Šå‚³åœ–ç‰‡</button>
        </form>
      </div>

      <div class="tab-pane fade" id="test" role="tabpanel" aria-labelledby="test-tab">

        <form method="POST" action="/inference" enctype="multipart/form-data" id="inferForm" class="mb-3">
          <div class="mb-3">
            <label for="modelSelect" class="form-label">ç›®å‰ä½¿ç”¨æ¨¡å‹</label>
            <select id="modelSelect" name="model" class="form-select">
            </select>
            <div class="mb-3" id="modelversion" style="display: none;">
              <label for="modelversionSelect" class="form-label"> æ¨¡å‹ç‰ˆæœ¬ </label>
              <select id="modelversionSelect" name="model_version_select" class="form-select">

              </select>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">åŸåœ–èˆ‡æ¸¬è©¦çµæœåœ–</label>
            <div class="row" id="resultPreviewArea">
              
            </div>
          </div>

          <button type="button" id="downloadZipBtn" class="btn btn-outline-secondary">ä¸‹è¼‰ ZIP</button>
          <button type="submit" class="btn btn-success">æ¸¬è©¦æ¨¡å‹</button>
        </form>

      </div>
      <div id="modal-container"></div>
      <div id="modal-container-loading"></div>
    </div>
  </div>
  </body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Bootstrap JS Bundle (åŒ…å« Popper) -->
  <script type="module">
    import { showLoadingModal, loadModal, loadingModal, showModal, hideLoadingModal } from "{{ url_for('static', filename='js/modal.js') }}";
    loadModal("modal-container");
    loadModal("modal-container-loading");

    let currentImage = "";
    let currentModel = "";
    let modelList = {{ model_list | tojson }};
    let progressInterval = null;
    let polygons = [];
    let uploadedFilenames = [];
    // å„²å­˜æ¨è«–å®Œæˆå¾Œçš„çµæœåœ– URLs
    let currentResultURLs = [];

    document.getElementById("downloadZipBtn").addEventListener("click", () => {
      fetch("/download_results_zip")
        .then(response => response.blob())
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "results.zip";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        });
    });

    function updateModelVersionOptions() {
      const modelSelect = document.getElementById("modelSelect");
      const versionDiv = document.getElementById("modelversion");
      const versionSelect = document.getElementById("modelversionSelect");

      const selectedModel = modelSelect.value;
      versionSelect.innerHTML = "";

      if (modelList[selectedModel]) {
        versionDiv.style.display = "block";
        modelList[selectedModel].forEach(function (version) {
          const option = document.createElement("option");
          option.value = version;
          option.textContent = version;
          versionSelect.appendChild(option);
        });
      } else {
        versionDiv.style.display = "none";
      }
    }

    document.getElementById("modelSelect").addEventListener("change", updateModelVersionOptions);

    document.addEventListener("DOMContentLoaded", () => {

        const form = document.getElementById("inferForm");
        form.addEventListener("submit", function (e) {
          e.preventDefault();

          console.log("uploadedFilenames:", uploadedFilenames.length);

          const model_version = document.getElementById("modelversionSelect").value;
          const model_type = document.getElementById("modelSelect").value;

          if (model_version == "") {
            showModal("è«‹é¸æ“‡ä¸€çµ„pretrained modelåšæ¸¬è©¦", () => {
            // OK æ™‚åŸ·è¡Œ
              console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
            }, () => {
              // Cancel æ™‚åŸ·è¡Œ
              console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
            });
            return;
          } else if (uploadedFilenames.length == 0) {
            showModal("è«‹è‡³ 'ä¸Šå‚³åœ–ç‰‡' åˆ†é è¼‰å…¥åœ–ç‰‡åšæ¸¬è©¦", () => {
            // OK æ™‚åŸ·è¡Œ
              console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
            }, () => {
              // Cancel æ™‚åŸ·è¡Œ
              console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
            });
            return;
          }

          /*
          const formData = new FormData();
          uploadedFilenames.forEach(filename => {
            formData.append("filenames", filename);
          });
          formData.append("model", model);
          */

          const xhr = new XMLHttpRequest();
          xhr.open("POST", "/inference", true);
          xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

          const payload = {
            filenames: uploadedFilenames,
            model: model_version
          };

          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4 && xhr.status === 200) {
              const res = JSON.parse(xhr.responseText);

              if (res.success == true) {
                  // é¡¯ç¤º Loading
                  // showLoadingModal();
                  loadingModal(
                    () => console.log("æŒ‰ä¸‹ OK"),
                    () => {
                          console.log("æŒ‰ä¸‹ Cancel, ä¸¦å·²ç™¼é€ /cancel_training");
                    }
                  );

                  const formData = new FormData();
                  formData.append("model_name", model_version);
                  formData.append("model_type", model_type);

                  fetch("/start_inference", {
                    method: "POST",
                    body: formData
                  })
                  .then(res => {})
                  .then(data => {})
                  .catch(err => {
                      showModal("æ¸¬è©¦å•Ÿå‹•å¤±æ•—ï¼š" + err.message, () => {
                      // OK æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                    }, () => {
                      // Cancel æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                    });
                  });
                  progressInterval = setInterval(fetchProgress, 2000);
                  fetchProgress();
              } else {
                if (res.message == "no file found") {
                  showModal("è«‹é‡æ–°è‡³ 'ä¸Šå‚³åœ–ç‰‡' åˆ†é è¼‰å…¥åœ–ç‰‡åšæ¸¬è©¦", () => {
                    // OK æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                  }, () => {
                      // Cancel æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                  });
                } else if (res.message == "no model found") {
                  showModal("è«‹é¸æ“‡ä¸€çµ„pretrained modelåšæ¸¬è©¦", () => {
                  // OK æ™‚åŸ·è¡Œ
                    console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                  }, () => {
                    // Cancel æ™‚åŸ·è¡Œ
                    console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                  });
                }
              }
            }
          }

          xhr.send(JSON.stringify(payload));
        });
    });

    function fetchProgress() {
        console.log("[å®šæ™‚] å‘¼å« fetchProgress");

        fetch("/inferencing")
            .then(res => res.json())
            .then(data => {
                console.log("data:", data);
                const success = data.success;
                const message = data.message;
                const result_img_urls = data.result_img_urls;
                const current_index = data.current_index;
                const total_num_imgs = data.total_num_imgs;

                document.getElementById("progressText-inference").innerText = `${current_index} / ${total_num_imgs}`;
                
                if (success == true && message == "inference complete" && progressInterval != null) {
                    console.log("åµæ¸¬åˆ° finished");
                    hideLoadingModal();
                    clearInterval(progressInterval);
                    progressInterval = null;

                    const imagePairs = [];

                    for (let i = 0; i < data.filenames.length; i++) {
                      imagePairs.push({
                        original: `/static/uploads/${data.filenames[i]}`,
                        result: result_img_urls[i]
                      });
                    }                
                
                    renderAllResults(imagePairs, 1);

                    showModal("æ¨è«–å®Œæˆï¼", () => {
                    // OK æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                    }, () => {
                      // Cancel æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                    });
                } else if (success == false && message == "no file found") {
                    showModal("è«‹é‡æ–°è‡³ 'ä¸Šå‚³åœ–ç‰‡' åˆ†é è¼‰å…¥åœ–ç‰‡åšæ¸¬è©¦", () => {
                    // OK æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                    }, () => {
                      // Cancel æ™‚åŸ·è¡Œ
                      console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
                    });
                }
            })
            .catch(err => {
                console.error("[fetchProgress éŒ¯èª¤]", err);
            });
    }

    document.getElementById("uploadForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const form = e.target;
        const formData = new FormData();

        // å…«å€‹éƒ¨ä½å°æ‡‰çš„ name
        const parts = ["1", "2", "3", "4", "5", "6", "7", "8"];
        let allSelected = true;

        parts.forEach(code => {
          const input = document.getElementById("upload_" + code);
          console.log(input.files[0]);

          if (!input || input.files.length === 0) {
            allSelected = false;
          } else {
            formData.append(code, input.files[0]);  // åŠ å…¥å–®ä¸€æª”æ¡ˆï¼ˆæ¯å€‹éƒ¨ä½ä¸€å¼µï¼‰
          }
        });

        console.log("formData:", formData);

        if (!allSelected) {
          showModal("è«‹é¸æ“‡æ‰€æœ‰å…«å€‹æ–¹ä½çš„åœ–ç‰‡ï¼", () => {
          // OK æ™‚åŸ·è¡Œ
            console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
          }, () => {
            // Cancel æ™‚åŸ·è¡Œ
            console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
          });
          return;
        }

        fetch("/upload_multi", {
          method: "POST",
          body: formData
          })
          .then(res => res.json())
          .then(data => {

            uploadedFilenames = data.filenames;  // å„²å­˜ filenames é™£åˆ—ï¼ˆ['a.jpg', ..., 'h.jpg']ï¼‰

            showModal("ä¸Šå‚³æˆåŠŸï¼Œå…±ä¸Šå‚³ " + Object.keys(data.filenames).length + " å¼µ", () => {
                // OK æ™‚åŸ·è¡Œ
                const imagePairs = [];

                for (let i = 0; i < data.filenames.length; i++) {
                  imagePairs.push({
                    original: `/static/uploads/${data.filenames[i]}`,
                    result: data.result_img_urls[i]
                  });
                }                
                
                renderAllResults(imagePairs, 0);
            }, () => {
                // Cancel æ™‚åŸ·è¡Œ
                console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
            });

            // è‡ªå‹•åˆ‡æ›è‡³ Test åˆ†é 
            const testTab = new bootstrap.Tab(document.getElementById('test-tab'));
            testTab.show();
          })
          .catch(err => {
            showModal("ä¸Šå‚³å¤±æ•—ï¼š" + err.message, () => {
            // OK æ™‚åŸ·è¡Œ
              console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
            }, () => {
              // Cancel æ™‚åŸ·è¡Œ
              console.log("ä½¿ç”¨è€…å–æ¶ˆäº†æ“ä½œ");
            });
          });
    });

    function renderAllResults(imagePairs, inference_mode) {
      const resultArea = document.getElementById("resultPreviewArea");
      resultArea.innerHTML = ""; // æ¸…ç©ºèˆŠçš„

      imagePairs.forEach((pair, index) => {
        const col = document.createElement("div");
        col.className = "col-md-3 mb-4"; // æ¯è¡Œ 4 å¼µåœ–ï¼ˆå¯èª¿æ•´ï¼‰

        if (inference_mode == false) {
          col.innerHTML = `
            <div class="card">
              <div class="card-body p-2">
                <h6 class="card-title text-center mb-2">ç¬¬ ${index + 1} å¼µ</h6>
                <div class="d-flex flex-column align-items-center">
                  <img src="${pair.original}" alt="åŸåœ– ${index + 1}" class="img-fluid mb-2" style="max-height: 120px;">
                </div>
              </div>
            </div>
          `;
        } else {
          col.innerHTML = `
            <div class="card">
              <div class="card-body p-2">
                <h6 class="card-title text-center mb-2">ç¬¬ ${index + 1} å¼µ</h6>
                <div class="d-flex flex-column align-items-center">
                  <img src="${pair.result}" alt="çµæœåœ– ${index + 1}" class="img-fluid border border-success" style="max-height: 120px;">
                </div>
              </div>
            </div>
          `;
        }

        resultArea.appendChild(col);
      });
    }

    function clearResultImg() {
      resultImg.src = "";
      resultImg.style.display = "none";
    }

    function loadImage(filename) {
      const img = new Image();
      img.onload = () => {
        fetch('/load_annotation/' + filename)
          .then(res => res.json())
          .then(data => {
            polygons = data;
          });
      };
      img.src = `/static/uploads/${filename}`;
    }

    // åˆå§‹åŒ–è¼‰å…¥æ¨¡å‹åˆ—è¡¨è·Ÿåœ–ç‰‡åˆ—è¡¨
    fetch('/models')
      .then(res => res.json())
      .then(models => {
        const sel = document.getElementById('modelSelect');
        sel.innerHTML = "";
        for (let model of models) {
          let opt = document.createElement('option');
          opt.value = model;
          opt.innerText = model;
          sel.appendChild(opt);
        }

        sel.value = "{{ model_type }}";
      });

    // Bind pic buttons
    const partCodes = ["1", "2", "3", "4", "5", "6", "7", "8"];
    partCodes.forEach(code => {
        const btn = document.getElementById("SelectBtn_" + code);
        const input = document.getElementById("upload_" + code);

        btn.addEventListener("click", () => {
          input.click();
        });

        input.addEventListener("change", () => {
          if (input.files && input.files[0]) {
            btn.innerText = "å·²é¸æ“‡";
            btn.style.backgroundColor = "#28a745";
            btn.style.color = "white";
          }
        });
    })

    updateModelVersionOptions();
  </script>
  {% endblock %}
</html>
